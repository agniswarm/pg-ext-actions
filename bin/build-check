#!/usr/bin/env bash
set -euo pipefail
set -x

# Detect operating system
detect_os() {
    case "$(uname -s)" in
        Linux*)     echo "linux" ;;
        Darwin*)    echo "macos" ;;
        CYGWIN*|MINGW*|MSYS*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

OS=$(detect_os)
echo "Detected OS: $OS"

# Function to run make (or nmake) with appropriate permissions and safe arg handling.
# Usage: run_make <target> "<extra-vars>"
# Example: run_make "" ""                 -> runs: make
#          run_make "install" ""          -> runs: make install
#          run_make "install" "PGUSER=postgres" -> runs: make PGUSER=postgres install
run_make() {
    local target="${1:-}"      # may be empty => default make target (build)
    local extra="${2:-}"       # optional additional variables, e.g. "PGUSER=postgres"
    local cmd

    case "$OS" in
        "windows")
            # prefer nmake / Makefile.win on Windows if present
            if [ -f "Makefile.win" ]; then
                # Use nmake; pass extra vars (unquoted) if provided
                if [ -n "$extra" ]; then
                    cmd=(nmake /NOLOGO /F Makefile.win $extra $target)
                else
                    cmd=(nmake /NOLOGO /F Makefile.win $target)
                fi
            else
                # fallback to mingw32-make or make
                if command -v mingw32-make >/dev/null 2>&1; then
                    if [ -n "$extra" ]; then
                        cmd=(mingw32-make $extra $target)
                    else
                        cmd=(mingw32-make $target)
                    fi
                else
                    if [ -n "$extra" ]; then
                        cmd=(make $extra $target)
                    else
                        cmd=(make $target)
                    fi
                fi
            fi
            ;;
        "macos")
            export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"
            
            # Find PostgreSQL installation and set PG_CONFIG
            if [ -f "/opt/homebrew/bin/pg_config" ]; then
                export PG_CONFIG="/opt/homebrew/bin/pg_config"
            elif [ -f "/usr/local/bin/pg_config" ]; then
                export PG_CONFIG="/usr/local/bin/pg_config"
            else
                echo "Error: pg_config not found. PostgreSQL development packages may not be installed."
                exit 1
            fi
            
            # Set additional PostgreSQL environment variables
            export PKG_CONFIG_PATH="/opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
            export LDFLAGS="-L/opt/homebrew/lib -L/usr/local/lib $LDFLAGS"
            export CPPFLAGS="-I/opt/homebrew/include -I/usr/local/include $CPPFLAGS"
            
            if [[ $target == "install" ]]; then
                # Use sudo for install target on macOS
                if [ -n "$extra" ]; then
                    cmd=(sudo make $extra $target)
                else
                    cmd=(sudo make $target)
                fi
            else
                if [ -n "$extra" ]; then
                    cmd=(make $extra $target)
                else
                    cmd=(make $target)
                fi
            fi
            ;;
        *)
            # linux / other unix
            if [[ $target == "install" ]]; then
                # Use sudo for install target on Linux/Unix
                if [ -n "$extra" ]; then
                    cmd=(sudo make $extra $target)
                else
                    cmd=(sudo make $target)
                fi
            else
                if [ -n "$extra" ]; then
                    cmd=(make $extra $target)
                else
                    cmd=(make $target)
                fi
            fi
            ;;
    esac

    # Print and run the command safely (array expansion avoids quoting issues)
    echo "Running: ${cmd[*]}"
    "${cmd[@]}"
}

# Build and install extension
# NOTE: do not pass quoted empty tokens; only pass extra variables if non-empty.
run_make "" ""            # build (default target)
run_make "install" ""     # install

# Run regression tests (installcheck) -- set PGUSER=postgres to ensure correct user when needed
status=0
if ! run_make "installcheck" "PGUSER=postgres"; then
    status=$?
    echo "installcheck failed with status ${status}"
fi

# If regression diffs exist, print them for debugging
if [ "${status}" -ne 0 ] && [ -f regression.diffs ]; then
    echo "=== regression.diffs ==="
    cat regression.diffs || true
fi

exit ${status}
